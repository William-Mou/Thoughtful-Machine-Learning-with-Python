X-Account-Key: account5
X-UIDL: GmailId12896c546349d4ed
X-Mozilla-Status: 0000
X-Mozilla-Status2: 00000000
X-Mozilla-Keys:                                                                                 
Delivered-To: mlsubscriber.tech@csmining.org
Received: by 10.143.160.8 with SMTP id m8cs25671wfo;
        Fri, 14 May 2010 05:23:51 -0700 (PDT)
Received: by 10.142.208.2 with SMTP id f2mr683964wfg.208.1273839830726;
        Fri, 14 May 2010 05:23:50 -0700 (PDT)
Return-Path: <filesystem-dev-bounces+mlsubscriber.tech=csmining.org@lists.apple.com>
Received: from bz2.apple.com (bz2.apple.com [17.254.13.37])
        by mx.google.com with ESMTP id e16si4356219wfg.7.2010.05.14.05.23.50;
        Fri, 14 May 2010 05:23:50 -0700 (PDT)
Received-SPF: pass (google.com: manual fallback record for domain of filesystem-dev-bounces+mlsubscriber.tech=csmining.org@lists.apple.com designates 17.254.13.37 as permitted sender) client-ip=17.254.13.37;
Authentication-Results: mx.google.com; spf=pass (google.com: manual fallback record for domain of filesystem-dev-bounces+mlsubscriber.tech=csmining.org@lists.apple.com designates 17.254.13.37 as permitted sender) smtp.mail=filesystem-dev-bounces+mlsubscriber.tech=csmining.org@lists.apple.com
Received: from lists.apple.com (unknown [17.128.113.151])
	by bz2.apple.com (Postfix) with ESMTP id 667471C428869
	for <mlsubscriber.tech@csmining.org>; Fri, 14 May 2010 05:23:50 -0700 (PDT)
Received: from master.lists.apple.com (localhost [127.0.0.1])
	by lists.apple.com (Postfix) with ESMTP id 5FF7E27A3C734
	for <mlsubscriber.tech@csmining.org>; Fri, 14 May 2010 05:23:50 -0700 (PDT)
X-Original-To: filesystem-dev@lists.apple.com
Delivered-To: filesystem-dev@lists.apple.com
Received: from relay2.apple.com (relay2.apple.com [17.128.113.32])
	by lists.apple.com (Postfix) with ESMTP id 5A4C427A3C70B
	for <filesystem-dev@lists.apple.com>;
	Fri, 14 May 2010 05:23:47 -0700 (PDT)
Received: from mail-in11.apple.com (mail-in11.apple.com [17.254.13.7])
	by relay2.apple.com (Postfix) with ESMTP id 30473D4FAB3D
	for <filesystem-dev@lists.apple.com>;
	Fri, 14 May 2010 05:23:47 -0700 (PDT)
X-AuditID: 11fe0d07-b7cf7ae000003b23-a1-4bed40d2e059
Received: from daleenterprise.com (daleenterprise.com [67.78.11.229])
	by mail-in11.apple.com (Apple Secure Mail Relay) with SMTP id
	87.66.15139.2D04DEB4; Fri, 14 May 2010 05:23:47 -0700 (PDT)
Received: from localhost (localhost [127.0.0.1])
	by daleenterprise.com (Postfix) with ESMTP id 434B112B6B35
	for <filesystem-dev@lists.apple.com>;
	Fri, 14 May 2010 08:23:45 -0400 (EDT)
Received: from daleenterprise.com ([127.0.0.1])
	by localhost (daleenterprise.com [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id 25292-07 for <filesystem-dev@lists.apple.com>;
	Fri, 14 May 2010 08:23:43 -0400 (EDT)
Received: from [10.1.100.11] (unknown [67.78.11.226])
	by macftphttp.serverbox.org (Postfix) with ESMTP id 3F97312B6B2B
	for <filesystem-dev@lists.apple.com>;
	Fri, 14 May 2010 08:23:43 -0400 (EDT)
Mime-Version: 1.0 (Apple Message framework v752.2)
In-Reply-To: <72A5186F-F05B-4913-9AFC-B8AD30485E5E@macftphttp.serverbox.org>
References: <8FBFF1C1-4D28-4BC8-A654-8397CA78DD9F@macftphttp.serverbox.org>
	<3402013F-F670-45D7-BDA3-278E64956B7D@apple.com>
	<16C3EDF1-0950-4E3E-9A2C-311481095169@macftphttp.serverbox.org>
	<CB4ED98B-D077-47FA-AC7C-3740BB63B29F@apple.com>
	<48E28D41-827A-4031-A453-C0CA08DF7DD9@macftphttp.serverbox.org>
	<7AE05B12-9AFE-4BE3-B31B-83E212DD6759@apple.com>
	<394951BF-24B3-4D43-A441-C44D9C9EAD5E@macftphttp.serverbox.org>
	<AANLkTinpmo4pRymWHTOpnE2V5a17_K_vq-TMcR_a7jdD@mail.csmining.org>
	<72A5186F-F05B-4913-9AFC-B8AD30485E5E@macftphttp.serverbox.org>
Content-Type: text/plain; charset=US-ASCII; delsp=yes; format=flowed
Message-Id: <F2AC24BB-E13B-46E5-B438-47439676F78C@macftphttp.serverbox.org>
Content-Transfer-Encoding: 7bit
From: websrvr <websrvr@macftphttp.serverbox.org>
Date: Fri, 14 May 2010 08:23:42 -0400
To: filesystem-dev@lists.apple.com
X-Mailer: Apple Mail (2.752.2)
MTA-Interface: amavisd-new-2.3.3 (2005-08-22) + Maia Mailguard 1.0.1 at
	daleenterprise.com
XScanned: using SpamAssassin 3.1.7 (2006-10-05) at daleenterprise.com
X-Virus-Scanned: using ClamAV 0.96 (2010-03-15) at daleenterprise.com
X-Brightmail-Tracker: AAAAAwBUIXcUKR60FCkgeg==
Subject: Re: auto mounting a partition with nobrowse
X-BeenThere: filesystem-dev@lists.apple.com
X-Mailman-Version: 2.1.5
Precedence: list
List-Id: Developer discussions of file system technologies
	<filesystem-dev.lists.apple.com>
List-Unsubscribe: <http://lists.apple.com/mailman/listinfo/filesystem-dev>,
	<mailto:filesystem-dev-request@lists.apple.com?subject=unsubscribe>
List-Post: <mailto:filesystem-dev@lists.apple.com>
List-Help: <mailto:filesystem-dev-request@lists.apple.com?subject=help>
List-Subscribe: <http://lists.apple.com/mailman/listinfo/filesystem-dev>,
	<mailto:filesystem-dev-request@lists.apple.com?subject=subscribe>
Sender: filesystem-dev-bounces+mlsubscriber.tech=csmining.org@lists.apple.com
Errors-To: filesystem-dev-bounces+mlsubscriber.tech=csmining.org@lists.apple.com

Example code:

#import <Foundation/Foundation.h>
#import <DiskArbitration/DiskArbitration.h>

DADissenterRef
DiskApproved(DADiskRef disk, void *context)
{
	char const *CdiskName = DADiskGetBSDName(disk);
	DADissenterRef dissenter;
	char *type;
	NSString *diskName = [NSString stringWithUTF8String:CdiskName];
	NSRange s1s1NumberRange = NSMakeRange([diskName length] - 4, 4);

	if([[diskName substringWithRange:s1s1NumberRange]  
isEqualToString:@"s3s1"]) /* check for our magic partition */
	{
		CFStringRef arguments[] =
		{
			CFStringCreateWithCString(kCFAllocatorDefault, "nobrowse",  
kCFStringEncodingUTF8),
			CFStringCreateWithCString(kCFAllocatorDefault, "owners",  
kCFStringEncodingUTF8),
			CFStringCreateWithCString(kCFAllocatorDefault, "suid",  
kCFStringEncodingUTF8),
			NULL
		};

		DADiskMountWithArguments(disk,
								NULL,
								kDADiskMountOptionDefault,
								NULL,
								NULL,
								arguments);

		/* deny the mount since we already mounted it */
		dissenter = DADissenterCreate(kCFAllocatorDefault,
									kDAReturnNotPermitted,
									CFSTR("mounted hidden"));

		type = "mounted hidden";
	}
	else
	{
		/* allow normal mounting */
		dissenter = NULL;

		type = "mounted normal";
	}

	printf("%s: %s\n", CdiskName, type);

	return dissenter;
}

int
main (int argc, const char * argv[])
{
     NSAutoreleasePool *pool = [NSAutoreleasePool new];
	DAApprovalSessionRef session = DAApprovalSessionCreate 
(kCFAllocatorDefault);

	if (!session)
	{
		fprintf(stderr, "failed to create Disk Arbitration session");
		goto out;
	}

	DARegisterDiskMountApprovalCallback(session,
										NULL,  // matches all disk objects
										DiskApproved,
										NULL); // context

	DAApprovalSessionScheduleWithRunLoop(session,
										 CFRunLoopGetCurrent(),
										 kCFRunLoopDefaultMode);

	CFRunLoopRunInMode(kCFRunLoopDefaultMode,
						60 /* seconds */,
						false);

	DAApprovalSessionUnscheduleFromRunLoop(session,
										 CFRunLoopGetCurrent(),
										 kCFRunLoopDefaultMode);

	DAUnregisterApprovalCallback(session,
								DiskApproved,
								NULL);

out:
    if (session)
		CFRelease(session);

     [pool release];

	return 0;
}


________________________________________________________________________ 
_______________________


The example appears to work but I'm noticing when calling  
DADiskMountWithArguments() from the callback function it seems to  
trigger the approval process for the same partition, is there  
something I need to do to prevent this?

Also, is it possible to change the mountroot rather than specifying a  
mountpoint???

I've look at suggested solution to my mount issue and a manual  
solution is not acceptable or the use of the fstab file because it  
cannot be guaranteed that it exists or that the content will be correct.

It has been suggested that example code does exist however no one has  
point me to or provided me with or even a link to any sample code and  
google is pretty useless.

-- Dale
 _______________________________________________
Do not post admin requests to the list. They will be ignored.
Filesystem-dev mailing list      (Filesystem-dev@lists.apple.com)
Help/Unsubscribe/Update your Subscription:
http://lists.apple.com/mailman/options/filesystem-dev/mlsubscriber.tech%40csmining.org

This email sent to mlsubscriber.tech@csmining.org

